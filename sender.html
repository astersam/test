<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sender Bridge</title>
</head>
<body>
    <!-- This page is a transactional bridge. It receives combined data and sets multiple cookies. -->
    <script>
        // Helper function to set a cookie.
        function setCookie(name, value, days = 1) {
            // Value is expected to be URI encoded already by the parent
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = `${name}=${value}; ${expires}; SameSite=None; Secure; Path=/`;
            console.log(`Cookie set/updated: ${name}`);
        }

        // --- Main Logic ---
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const activeChatsEncoded = urlParams.get('active_chats'); // Encoded JSON array
            const selectedChatId = urlParams.get('selected_chat_id'); // Plain chat ID
            const selectedChatMessagesEncoded = urlParams.get('selected_chat_messages'); // Encoded JSON array

            try {
                // 1. Set the active_chats cookie if data is present
                if (activeChatsEncoded) {
                    setCookie('active_chats', activeChatsEncoded);
                }

                // 2. Set the cookie for the selected chat if data is present
                if (selectedChatId && selectedChatMessagesEncoded) {
                    setCookie(selectedChatId, selectedChatMessagesEncoded);
                }

            } catch (e) {
                console.error("Bridge Sender Error:", e);
            } finally {
                // Close the window after a tiny delay to ensure cookies are set.
                setTimeout(() => {
                    window.close();
                }, 50);
            }
        })();
    </script>
</body>
</html>

