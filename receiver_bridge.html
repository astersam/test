<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PostMessage LocalStorage Bridge</title>
</head>
<body>
    <!-- This page is intended to be loaded inside an invisible iframe. 
         It constantly monitors its own localStorage for changes and blasts 
         the new data back to the parent window via postMessage. -->
    <script>
        // --- Configuration ---
        const MESSAGE_KEY = 'cross-page-communication-data';
        const POLLING_INTERVAL = 500; // Check every 500ms (0.5 seconds)
        const VERBOSE_LOG_INTERVAL = 5000; // Log status every 5 seconds
        
        let lastReceivedJson = null;
        let logIntervalId = null;

        // Check if the page is loaded within an iframe
        const isIframed = window.parent !== window;
        const parentOrigin = '*'; // Using '*' because the receiver handles the security check.

        // --- Debugging and Polling Functions ---

        /**
         * Sends a postMessage to the parent window if the data has changed.
         * @param {string} currentJson - The current raw JSON string from localStorage.
         */
        function checkAndBridge(currentJson) {
            
            // Log detailed comparison to the IFRAME'S console
            console.log('\n--- 🔀 Polling active. ---');
            console.log('  - LAST:', lastReceivedJson);
            console.log('  - CURRENT:', currentJson);

            // 1. Check for change or if it's the first time running (initial send)
            if (currentJson !== lastReceivedJson) {
                
                // If the key was deleted (currentJson is null)
                if (currentJson === null) {
                    console.warn('SUCCESS: LocalStorage key cleared. Sending null signal.');
                    lastReceivedJson = null;
                    // Send an empty signal
                    window.parent.postMessage(JSON.stringify({ payload: null }), parentOrigin);
                    return;
                }

                // If new or changed data exists
                try {
                    // Try to parse just to ensure it's valid JSON before sending
                    JSON.parse(currentJson); 
                    
                    // --- SUCCESS: SEND MESSAGE ---
                    window.parent.postMessage(currentJson, parentOrigin);
                    lastReceivedJson = currentJson; // Update the last sent state
                    console.log('✅ SUCCESS: New message bridged to parent via postMessage!');

                } catch (e) {
                    console.error('ERROR: LocalStorage content is not valid JSON.', currentJson);
                }
            } else {
                 // console.log('STATUS: No change detected.');
            }
        }
        
        /**
         * Main function to start polling for changes in localStorage.
         */
        function startPolling() {
            if (!isIframed) {
                console.warn('STATUS: Not running in an iframe. Polling is inactive.');
                return;
            }

            console.log(`✅ Bridge initialized. Starting ${POLLING_INTERVAL}ms polling for LocalStorage changes.`);
            
            // --- Step 1: Force Initial Check ---
            // This is crucial to send the current state immediately upon load.
            const initialJson = localStorage.getItem(MESSAGE_KEY);
            if (initialJson) {
                // Set the initial state and send it immediately
                lastReceivedJson = initialJson;
                window.parent.postMessage(initialJson, parentOrigin);
                console.log('⭐ Sent initial LocalStorage state on load.');
            }
            
            // --- Step 2: Start Continuous Polling ---
            setInterval(() => {
                const currentJson = localStorage.getItem(MESSAGE_KEY);
                checkAndBridge(currentJson);
            }, POLLING_INTERVAL);

            // --- Step 3: Start Verbose Logging ---
            logIntervalId = setInterval(() => {
                console.log(`\n[HEARTBEAT] Polling active. Last sent: ${lastReceivedJson ? lastReceivedJson.substring(0, 40) + '...' : 'null'}`);
            }, VERBOSE_LOG_INTERVAL);
        }

        // Initialize on page load
        window.onload = startPolling;

        // Cleanup on page unload (optional, but good practice)
        window.onbeforeunload = () => {
            if (logIntervalId) {
                clearInterval(logIntervalId);
            }
        };
    </script>
</body>
</html>
