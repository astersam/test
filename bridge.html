<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Communication Bridge</title>
</head>
<body>
    <script>
        const MESSAGE_KEY = 'github-cross-page-bridge-message';

        const urlParams = new URLSearchParams(window.location.search);
        const messageToSend = urlParams.get('message');
        const senderId = urlParams.get('senderId');
        
        // ** THE FIX IS HERE (PART 1) **
        // The receiver now provides its origin, which we will use as the target.
        const parentOrigin = urlParams.get('origin');

        if (messageToSend && senderId) {
            // --- SENDER MODE ---
            const messageData = {
                payload: messageToSend,
                senderId: senderId,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem(MESSAGE_KEY, JSON.stringify(messageData));
            } catch (e) {
                console.error('Bridge Error (Send):', e);
            }
            window.close();

        } else if (parentOrigin) {
            // --- RECEIVER MODE ---
            const targetWindow = window.opener || window.parent;

            if (targetWindow && targetWindow !== window) {
                try {
                    const storedData = localStorage.getItem(MESSAGE_KEY);
                    if (storedData) {
                        // ** THE FIX IS HERE (PART 2) **
                        // We use the provided parentOrigin as the target origin for postMessage.
                        // This is secure and avoids the error.
                        targetWindow.postMessage(storedData, parentOrigin);
                    }
                } catch (e) {
                    console.error('Bridge Error (Receive):', e);
                }
            }
            
            if (window.opener) {
                window.close();
            }
        }
    </script>
</body>
</html>

